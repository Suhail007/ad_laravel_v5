[phases.setup]
cmds = [
    "apt-get update",
    "apt-get install -y --no-install-recommends libpng-dev libjpeg-dev libfreetype6-dev libzip-dev unzip"
]

[phases.build]
cmds = [
    "composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist",
    # Skip database-related commands during build
    "php -r \"file_put_contents('.env', str_replace('DB_CONNECTION=mysql', 'DB_CONNECTION=sqlite', file_get_contents('.env')));\"",
    "php artisan config:cache",
    "php artisan route:cache",
    "php artisan view:cache",
    "php artisan storage:link"
]

[phases.start]
cmds = ["php artisan migrate --force && php artisan serve --host=0.0.0.0 --port=$PORT"]

[phases.install]
cmds = ["echo 'Skipping install phase'"]

# Required system packages
[phases.build.nixPkgs]
php82 = {}
composer = {}
nodejs-18_x = {}

# Required libraries
[phases.build.nixLibraries]
libpng = {}
libjpeg = {}
freetype = {}
zip = {}
